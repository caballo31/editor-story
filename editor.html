<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>heyGuide ¬∑ Colecci√≥n ¬∑ Stories</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
<script>
  tailwind.config = {
    theme:{extend:{
      colors:{accent:"#EF4444", ink:"#0F172A", fog:"#f7f7f9"},
      boxShadow:{card:"0 12px 28px rgba(0,0,0,.10)", soft:"0 4px 12px rgba(0,0,0,.06)"},
      borderRadius:{'2xl':"1.25rem"},
      fontFamily:{
        sans:["-apple-system","BlinkMacSystemFont","Segoe UI","Roboto","Helvetica","Arial","Apple Color Emoji","Segoe UI Emoji","sans-serif"]
      }
    }}
  }
</script>

<style>
  html,body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji",sans-serif}
  .mesh-soft{
    background:
      radial-gradient(60% 60% at 50% 0%, rgba(239,68,68,.06), transparent),
      radial-gradient(35% 35% at 90% 10%, rgba(239,68,68,.05), transparent),
      radial-gradient(30% 30% at 10% 90%, rgba(239,68,68,.04), transparent);
  }
  .dash-block{ border:1.5px dashed #d1d5db; border-radius:16px; background:#fff; }
  .chip{
    background:#fff; border:1.5px dashed #d1d5db; border-radius:16px;
    padding:.5rem .875rem; display:inline-flex; gap:.5rem; align-items:center;
    box-shadow:0 4px 12px rgba(0,0,0,.06);
    transition:box-shadow .18s ease, transform .18s ease, border-color .18s ease;
  }
  .chip:hover{ box-shadow:0 6px 16px rgba(0,0,0,.08); transform:translateY(-1px); border-color:#cbd5e1 }
  .chip[aria-disabled="true"]{
    opacity:.5; cursor:not-allowed; filter:saturate(.5);
  }
  .btn-secondary{
    background:#fff; border:1px solid #e5e7eb; border-radius:999px;
    padding:.5rem 1rem; display:inline-flex; align-items:center; gap:.5rem;
    box-shadow:0 4px 12px rgba(0,0,0,.06);
    transition:box-shadow .18s ease, transform .18s ease, border-color .18s ease, background .18s ease;
  }
  .btn-secondary:hover{ box-shadow:0 6px 16px rgba(0,0,0,.08); transform:translateY(-1px); border-color:#d1d5db; }
  .btn-primary{
    background:#EF4444; color:#fff; border-radius:999px; padding:.5rem 1rem; font-weight:600;
    box-shadow:0 8px 24px rgba(239,68,68,.35);
  }
  .tag{ background:#f8fafc; border:1px solid #e5e7eb; border-radius:999px; padding:.125rem .5rem; font-size:.75rem; }

  .tile{ border:1.5px dashed #d1d5db; border-radius:16px; background:#fff; transition:box-shadow .18s ease, transform .18s ease, border-color .18s ease; }
  .tile:hover{ box-shadow:0 8px 20px rgba(0,0,0,.06); transform:translateY(-1px); border-color:#cbd5e1 }
  .tile[aria-disabled="true"]{ opacity:.5; cursor:not-allowed; }

  .thumb{ width:110px; height:70px; border-radius:12px; object-fit:cover; border:1px solid #e5e7eb; box-shadow:0 2px 8px rgba(0,0,0,.06) }
  .canvas-deg::after{
    content:""; position:absolute; inset:0; background:linear-gradient(to top, rgba(0,0,0,.14), rgba(0,0,0,.05), transparent); pointer-events:none; border-radius:12px;
  }
  .safe-bottom{ padding-bottom:max(16px, env(safe-area-inset-bottom)); }
  .toolbar{
    box-shadow:0 -8px 24px rgba(0,0,0,.08); border-top:1px solid #e5e7eb;
    background:rgba(255,255,255,.92); -webkit-backdrop-filter:blur(10px); backdrop-filter:blur(10px);
  }
  .modal{ position:fixed; inset:0; z-index:50; display:none; }
  .modal.open{ display:flex; background:rgba(15,23,42,.45); -webkit-backdrop-filter:blur(2px); backdrop-filter:blur(2px); }
  .modal-panel{ background:#fff; border-radius:1rem 1rem 0 0; width:100%; height:100%; display:flex; flex-direction:column; }
  @media (min-width:768px){ .modal-panel{ border-radius:1rem; max-width:720px; max-height:86vh; margin:auto; } }

  /* Mobile: editor fullscreen */
  @media (max-width: 1023px){
    #editorView.fullscreen{ position:fixed; inset:0; z-index:40; background:#fff; overflow:auto; }
    #mobileTopBar{ position:sticky; top:0; z-index:10; background:#fff; border-bottom:1px solid #e5e7eb; }
  }

  /* Sidebar cards */
  .card-media{ position:relative; }
  .card-media img{ display:block; width:100%; height:7rem; object-fit:cover; background:#e5e5e5; }
  .card-overlay{
    position:absolute; inset:0;
    background:linear-gradient(to top, rgba(0,0,0,.55), rgba(0,0,0,.25), rgba(0,0,0,0));
    pointer-events:none;
  }
  .state-chip{
    position:absolute; right:.5rem; bottom:.5rem;
    background:rgba(0,0,0,.65); color:#fff; font-size:.7rem; line-height:1; font-weight:600;
    border:1px solid rgba(255,255,255,.18);
    border-radius:999px; padding:.35rem .6rem;
    backdrop-filter:saturate(120%) blur(2px);
  }
  .meta-bar{
    position:absolute; left:0; right:0; bottom:0;
    display:flex; align-items:center; justify-content:space-between;
    padding:.45rem .5rem; color:#fff; font-size:.75rem;
  }

  .sidebar-item{ transition:box-shadow .18s ease, transform .18s ease, border-color .18s ease, background .18s ease; }
  .sidebar-item.is-active{
    border-color:#fca5a5; box-shadow:0 0 0 3px rgba(239,68,68,.18) inset, 0 10px 24px rgba(0,0,0,.08);
  }

  details.summary-card>summary{
    list-style:none; cursor:pointer; user-select:none;
    border:1px solid #e5e7eb; background:#fff; border-radius:16px; padding:.75rem 1rem;
    display:flex; align-items:center; justify-content:space-between; gap:.75rem;
    box-shadow:0 6px 18px rgba(0,0,0,.06);
  }
  details.summary-card[open]>summary{ border-bottom-left-radius:0; border-bottom-right-radius:0; }
  details.summary-card>summary::-webkit-details-marker{ display:none; }

  .toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:88px; z-index:60;
    background:#111827; color:#fff; padding:.6rem .9rem; border-radius:999px; font-size:.875rem;
    box-shadow:0 12px 28px rgba(0,0,0,.20); opacity:0; pointer-events:none; transition:opacity .18s ease, bottom .18s ease;
  }
  .toast.show{ opacity:1; bottom:98px; }
</style>
</head>
<body class="bg-white text-gray-900 mesh-soft min-h-screen">

  <!-- Header -->
  <header class="px-4 sm:px-6 py-4 border-b border-gray-200">
    <div class="max-w-6xl mx-auto flex items-center justify-between">
      <div class="flex items-center gap-2">
        <svg viewBox="0 0 256 256" aria-hidden="true" class="w-8 h-8">
          <g transform="translate(58,54) rotate(-5,100,70)">
            <rect x="0" y="40" width="140" height="90" rx="18" fill="#EF4444" opacity="0.20"/>
            <rect x="10" y="20" width="140" height="90" rx="18" fill="#EF4444" opacity="0.35"/>
            <rect x="20" y="0"  width="140" height="90" rx="18" fill="#EF4444"/>
          </g>
        </svg>
        <h1 class="text-lg font-semibold" id="colTitle">Colecci√≥n</h1>
      </div>
      <span class="text-sm text-gray-500">heyGuide</span>
    </div>
  </header>

  <!-- Layout -->
  <div class="max-w-6xl mx-auto lg:grid lg:grid-cols-[340px,1fr]">
    <!-- Sidebar -->
    <aside class="border-b lg:border-b-0 lg:border-r border-gray-200">
      <div class="px-4 sm:px-6 py-4">
        <h2 class="font-semibold">Colecci√≥n</h2>

        <!-- MOBILE: acorde√≥n inline -->
        <details id="collectionAccordion" class="summary-card lg:hidden mt-2">
          <summary>
            <div class="flex items-center gap-2">
              <span class="font-semibold" id="mColSummaryTitle">‚Äî</span>
              <span id="mColMini" class="text-xs text-gray-500"></span>
            </div>
            <span class="text-sm text-gray-600">Editar</span>
          </summary>
          <div class="border border-t-0 border-gray-200 rounded-b-2xl p-3 space-y-3">
            <div class="dash-block p-3">
              <input id="mColName" type="text" placeholder="T√≠tulo de la colecci√≥n" class="w-full border-0 focus:ring-0 focus:outline-none placeholder:text-gray-400"/>
            </div>
            <div class="dash-block p-3">
              <textarea id="mColDesc" rows="3" placeholder="Descripci√≥n breve" class="w-full border-0 focus:ring-0 focus:outline-none resize-y placeholder:text-gray-400"></textarea>
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div class="dash-block p-3">
                <label class="text-xs text-gray-500">Precio (‚Ç¨)</label>
                <input id="mColPrice" type="number" min="0" step="0.1" class="w-full border-0 focus:ring-0 focus:outline-none" placeholder="5.90"/>
              </div>
              <div class="dash-block p-3">
                <label class="text-xs text-gray-500">Idioma</label>
                <select id="mColLang" class="w-full border-0 focus:ring-0 focus:outline-none">
                  <option value="es">ES</option>
                  <option value="en">EN</option>
                  <option value="it">IT</option>
                </select>
              </div>
            </div>
            <div class="flex items-center justify-end">
              <button id="mColSaveBtn" class="btn-secondary">Guardar</button>
            </div>
          </div>
        </details>

        <!-- DESKTOP: card clickable -->
        <button id="collectionCard" class="hidden lg:block w-full text-left rounded-2xl border border-gray-200 bg-white overflow-hidden shadow-[0_6px_18px_rgba(0,0,0,.06)] hover:shadow-[0_10px_26px_rgba(0,0,0,.08)] transition mt-3 sidebar-item" aria-controls="collectionPanel" aria-expanded="true">
          <div class="p-3">
            <p class="font-semibold truncate" id="collectionCardTitle">Colecci√≥n</p>
            <p class="text-xs text-gray-500" id="collectionCardMeta">‚Äî</p>
          </div>
        </button>

        <!-- Stories -->
        <div class="mt-5 flex items-center justify-between">
          <h2 class="font-semibold">Stories</h2>
          <span id="countLabel" class="text-xs text-gray-500">0</span>
        </div>

        <div id="storiesList" class="mt-3 pb-20 space-y-2"></div>

        <!-- Tile Crear Story -->
        <button id="tileCreate" class="tile w-full mt-3 p-4 text-left">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-xl border border-gray-200 flex items-center justify-center" aria-hidden="true">
              <svg width="22" height="22" fill="none" stroke="#475569" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><circle cx="12" cy="12" r="9"/><path d="M12 8v8M8 12h8"/></svg>
            </div>
            <div>
              <p class="font-semibold">Crear Story</p>
              <p class="text-sm text-gray-600">A√±adir nueva historia a esta colecci√≥n</p>
            </div>
          </div>
        </button>
      </div>
    </aside>

    <!-- Columna derecha -->
    <section id="rightCol" class="min-w-0">
      <!-- PANEL DE COLECCI√ìN -->
      <section id="collectionPanel" class="hidden p-6" aria-labelledby="colTitle">
        <div class="max-w-2xl">
          <h3 class="text-lg font-semibold">Colecci√≥n ¬∑ Configuraci√≥n</h3>
          <p class="text-sm text-gray-600 mt-1">Primero define la colecci√≥n, luego gestiona las stories.</p>

          <div class="mt-5 grid gap-3">
            <div class="dash-block p-3">
              <label class="sr-only" for="colName">T√≠tulo</label>
              <input id="colName" type="text" placeholder="T√≠tulo de la colecci√≥n" class="w-full border-0 focus:ring-0 focus:outline-none placeholder:text-gray-400"/>
            </div>

            <div class="dash-block p-3">
              <label class="sr-only" for="colDesc">Descripci√≥n</label>
              <textarea id="colDesc" rows="4" placeholder="Descripci√≥n breve" class="w-full border-0 focus:ring-0 focus:outline-none resize-y placeholder:text-gray-400"></textarea>
            </div>

            <div class="grid sm:grid-cols-3 gap-3">
              <div class="dash-block p-3">
                <label class="text-xs text-gray-500">Categor√≠a</label>
                <select id="colCat" class="w-full border-0 focus:ring-0 focus:outline-none">
                  <option value="turismo">Turismo</option>
                  <option value="gastronomia">Gastronom√≠a</option>
                  <option value="productividad">Productividad</option>
                  <option value="arte">Arte</option>
                </select>
              </div>
              <div class="dash-block p-3">
                <label class="text-xs text-gray-500">Precio (‚Ç¨)</label>
                <input id="colPrice" type="number" min="0" step="0.1" class="w-full border-0 focus:ring-0 focus:outline-none" placeholder="Ej. 5.90"/>
              </div>
              <div class="dash-block p-3">
                <label class="text-xs text-gray-500">Idioma</label>
                <select id="colLang" class="w-full border-0 focus:ring-0 focus:outline-none">
                  <option value="es">ES</option>
                  <option value="en">EN</option>
                  <option value="it">IT</option>
                </select>
              </div>
            </div>

            <div class="grid sm:grid-cols-2 gap-3">
              <div class="dash-block p-3">
                <label class="text-xs text-gray-500">Visibilidad</label>
                <div class="mt-1 flex items-center gap-3" role="radiogroup" aria-label="Visibilidad de la colecci√≥n">
                  <label class="inline-flex items-center gap-2 text-sm">
                    <input type="radio" name="colVisibility" value="public" class="text-accent focus:ring-accent/30"/> P√∫blica
                  </label>
                  <label class="inline-flex items-center gap-2 text-sm">
                    <input type="radio" name="colVisibility" value="private" class="text-accent focus:ring-accent/30"/> Privada
                  </label>
                </div>
              </div>
              <div class="dash-block p-3">
                <label class="text-xs text-gray-500 block mb-2">Portada</label>
                <div class="flex items-center gap-3">
                  <img id="colCoverPreview" alt="" class="w-24 h-16 rounded-xl object-cover border border-gray-200 bg-gray-100"/>
                  <button id="colCoverBtn" class="btn-secondary">Cambiar portada</button>
                  <input id="colCoverInput" type="file" accept="image/*" class="hidden"/>
                </div>
              </div>
            </div>

            <div class="flex items-center justify-between mt-2">
              <div class="text-sm text-gray-600 flex items-center gap-3">
                <span id="colStats">‚Äî</span>
                <span id="saveHint" class="text-xs text-gray-400 hidden">‚Ä¢ Saved <span id="saveTime"></span></span>
              </div>
              <div class="flex items-center gap-2">
                <button id="colSaveBtn" class="btn-secondary">Guardar cambios</button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Editor (wizard) -->
      <section id="editorView" class="hidden" aria-live="polite">
        <!-- Top bar mobile -->
        <div id="mobileTopBar" class="lg:hidden flex items-center justify-between px-4 sm:px-6 py-3">
          <button id="btnBackToList" class="btn-secondary" aria-label="Volver">‚Üê Volver</button>
          <span class="text-sm text-gray-600 truncate" id="currentStoryName" aria-live="polite"></span>
          <span></span>
        </div>

        <main class="px-4 sm:px-6 pb-40 pt-4 lg:pt-6 max-w-4xl mx-auto">
          <div id="alert" class="hidden mb-4 rounded-xl border border-red-200 bg-red-50 text-red-800 px-4 py-3 text-sm">
            Falta completar: <b>Texto</b> + <b>1 visual</b>. Si no hay video ‚Üí <b>audio</b>.
          </div>

          <p id="emptyHint" class="text-sm text-gray-600 mb-2 hidden">Eleg√≠ subir un video üé¨ o im√°genes üñºÔ∏è. Si no hay video, a√±ad√≠ un audio.</p>

          <!-- Tiles iniciales -->
          <section id="emptyTiles" class="grid grid-cols-1 sm:grid-cols-3 gap-3 sm:gap-4">
            <button id="tileVideo" class="tile px-4 py-5 text-left focus:outline-none" aria-label="Subir video">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl border border-gray-200 flex items-center justify-center" aria-hidden="true">
                  <svg width="22" height="22" fill="none" stroke="#475569" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><rect x="3" y="5" width="14" height="14" rx="2"/><path d="M17 9l4-2v10l-4-2z"/></svg>
                </div>
                <div>
                  <p class="font-semibold">Subir video</p>
                  <p class="text-sm text-gray-600">Una sola fuente (sin audio TTS)</p>
                </div>
              </div>
            </button>

            <button id="tileSearch" class="tile px-4 py-5 text-left focus:outline-none" aria-label="Buscar imagen">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl border border-gray-200 flex items-center justify-center" aria-hidden="true">
                  <svg width="22" height="22" fill="none" stroke="#475569" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><circle cx="11" cy="11" r="7"/><path d="M21 21l-4.3-4.3"/></svg>
                </div>
                <div>
                  <p class="font-semibold">Buscar imagen</p>
                  <p class="text-sm text-gray-600">Fuentes p√∫blicas optimizadas</p>
                </div>
              </div>
            </button>

            <button id="tileUploadImg" class="tile px-4 py-5 text-left focus:outline-none" aria-label="Subir imagen">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl border border-gray-200 flex items-center justify-center" aria-hidden="true">
                  <svg width="22" height="22" fill="none" stroke="#475569" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><rect x="3" y="5" width="18" height="14" rx="2"/><path d="M10 13l2-2 4 4M7 12a1 1 0 110-2 1 1 0 010 2z"/></svg>
                </div>
                <div>
                  <p class="font-semibold">Subir imagen</p>
                  <p class="text-sm text-gray-600">Permite m√∫ltiples im√°genes</p>
                </div>
              </div>
            </button>
            <input id="inputUploadImg" type="file" accept="image/*" class="hidden" multiple/>
            <input id="inputUploadVideo" type="file" accept="video/*" class="hidden"/>
          </section>

          <!-- Canvas -->
          <section id="canvasSection" class="hidden mt-4">
            <div class="dash-block p-3 sm:p-4">
              <div id="canvasDrop" class="relative w-full aspect-video rounded-xl overflow-hidden bg-gray-100 canvas-deg">
                <img id="stageImg" alt="" class="absolute inset-0 w-full h-full object-cover hidden" loading="lazy"/>
                <video id="stageVideo" class="absolute inset-0 w-full h-full hidden" playsinline controls></video>
              </div>
              <div id="carousel" class="mt-3 overflow-x-auto no-scrollbar">
                <div id="thumbs" class="flex gap-3 snap-x" role="listbox" aria-label="Galer√≠a de miniaturas"></div>
              </div>
            </div>
          </section>

          <!-- Texto -->
          <section class="mt-4 space-y-3">
            <div class="dash-block p-3">
              <label for="title" class="sr-only">T√≠tulo</label>
              <input id="title" type="text" placeholder="T√≠tulo" class="w-full border-0 focus:ring-0 focus:outline-none placeholder:text-gray-400"/>
            </div>
            <div class="dash-block p-3">
              <label for="body" class="sr-only">Cuerpo</label>
              <textarea id="body" rows="5" placeholder="Cuerpo (texto descriptivo)" class="w-full border-0 focus:ring-0 focus:outline-none resize-y placeholder:text-gray-400"></textarea>
            </div>
          </section>

          <!-- Metadatos -->
          <section id="metaSection" class="mt-4 space-y-3">
            <div id="metaList" class="flex flex-wrap items-center gap-2"></div>

            <!-- Audio mini player (solo si NO hay video) -->
            <div id="audioWrap" class="hidden">
              <div class="dash-block p-3 flex items-center justify-between gap-3">
                <div class="flex items-center gap-2">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#111827" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>
                  <span class="text-sm text-gray-800">Listo para reproducir</span>
                </div>
                <div class="flex items-center gap-2">
                  <button id="btnPlay" class="chip" aria-label="Reproducir/Pausar audio" aria-pressed="false"><span id="playLabel">‚ñ∂Ô∏é</span></button>
                  <button id="btnAudioRemove" class="btn-secondary" aria-label="Quitar audio">Quitar</button>
                </div>
                <audio id="audioEl" preload="none"></audio>
              </div>
            </div>
          </section>
        </main>

        <!-- Toolbar contextual -->
        <div id="editorToolbar" class="fixed inset-x-0 bottom-0 toolbar hidden" role="region" aria-label="Barra de acciones">
          <div class="max-w-4xl mx-auto px-4 sm:px-6 safe-bottom">
            <div class="flex items-center justify-between gap-2 py-3">
              <div class="flex flex-wrap items-center gap-2" id="chipsLeft">
                <button id="chipLoc" class="chip" aria-label="Ubicaci√≥n" aria-pressed="false">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#111827" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4.5 8-12a8 8 0 10-16 0c0 7.5 8 12 8 12z"/><circle cx="12" cy="10" r="3"/></svg>
                  <span>Ubicaci√≥n</span>
                </button>
                <button id="chipFile" class="chip" aria-label="Adjunto" aria-pressed="false">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#111827" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 00-2 2v16l4-2 4 2 4-2 4 2V8z"/></svg>
                  <span>Adjunto</span>
                </button>
                <button id="chipAudio" class="chip" aria-label="Audio (TTS o archivo)" aria-pressed="false">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#111827" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M11 5l6-2v10"/><rect x="4" y="9" width="4" height="11" rx="1"/><rect x="12" y="13" width="4" height="7" rx="1"/></svg>
                  <span>Audio</span>
                </button>

                <!-- NUEVO (MVP): Chip IA limitado -->
                <button id="chipAI" class="chip" aria-label="Asistente IA" aria-pressed="false" aria-disabled="true" title="A√±ad√≠ t√≠tulo o cuerpo para usar IA">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#111827" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <path d="M12 3l2.2 4.5L19 8l-3.6 3.5L16 17l-4-2.1L8 17l.6-5.5L5 8l4.8-.5L12 3z"/>
                  </svg>
                  <span>IA</span>
                </button>

                <button id="chipAddImg" class="chip hidden" aria-label="Subir imagen extra" aria-pressed="false">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#111827" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="5" width="18" height="14" rx="2"/><path d="M10 13l2-2 4 4M7 12a1 1 0 110-2 1 1 0 010 2z"/></svg>
                  <span>Subir imagen</span>
                </button>
                <button id="chipSearchImg" class="chip hidden" aria-label="Buscar im√°genes" aria-pressed="false">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#111827" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="7"/><path d="M21 21l-4.3-4.3"/></svg>
                  <span>Buscar im√°genes</span>
                </button>
              </div>
              <div class="flex items-center gap-2">
                <button id="btnPreview" class="btn-secondary" aria-label="Previsualizar">Preview</button>
                <button id="btnSave" class="btn-primary" aria-label="Guardar">Guardar</button>
              </div>
            </div>
          </div>
        </div>
      </section>
    </section>
  </div>

  <!-- STICKY ‚ÄúCrear Story‚Äù (solo mobile) -->
  <div id="mobileCreateSticky" class="lg:hidden fixed inset-x-0 bottom-0 px-4 sm:px-6 pb-[max(12px,env(safe-area-inset-bottom))] pt-1 z-30">
    <div class="rounded-full shadow-[0_12px_32px_rgba(239,68,68,.30)]">
      <button id="stickyCreateBtn" class="w-full inline-flex items-center justify-center rounded-full bg-accent text-white px-5 py-2.5 font-semibold">
        + Crear Story
      </button>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite">Guardado</div>

  <!-- Modales (Buscar, Audio, Ubicaci√≥n, Preview, IA, Publicar) -->
  <div id="modalSearch" class="modal" role="dialog" aria-modal="true" aria-labelledby="searchTitle">
    <div class="modal-panel">
      <header class="px-4 sm:px-6 py-4 border-b border-gray-200 flex items-center justify-between">
        <h2 id="searchTitle" class="text-lg font-semibold">Buscar im√°genes</h2>
        <button class="btn-secondary" data-close aria-label="Cerrar">‚úï</button>
      </header>
      <div class="p-4 sm:p-6 overflow-auto grow space-y-4">
        <div class="flex items-center gap-2">
          <label class="sr-only" for="q">Buscar</label>
          <input id="q" type="search" placeholder="Ej. Coliseo, pasta, Napoli‚Ä¶" class="w-full rounded-xl border border-gray-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-accent/30 focus:border-accent/50">
          <button id="btnDoSearch" class="btn-secondary" aria-label="Buscar">Buscar</button>
        </div>
        <div id="results" class="grid grid-cols-2 sm:grid-cols-3 gap-3"></div>
      </div>
      <footer class="px-4 sm:px-6 py-4 border-t border-gray-200">
        <button class="btn-secondary" data-close aria-label="Cerrar">Cerrar</button>
      </footer>
    </div>
  </div>

  <div id="modalAudio" class="modal" role="dialog" aria-modal="true" aria-labelledby="audioTitle">
    <div class="modal-panel">
      <header class="px-4 sm:px-6 py-4 border-b border-gray-200 flex items-center justify-between">
        <h2 id="audioTitle" class="text-lg font-semibold">Audio</h2>
        <button class="btn-secondary" data-close aria-label="Cerrar">‚úï</button>
      </header>
      <div class="p-4 sm:px-6 sm:py-6 px-4 py-4 overflow-auto grow space-y-4">
        <p class="text-sm text-gray-700">Eleg√≠ el origen del audio:</p>
        <div class="flex flex-col sm:flex-row gap-2">
          <button id="audioFileBtn" class="btn-secondary">Archivo</button>
          <button id="audioTTSBtn" class="btn-secondary">TTS (mock)</button>
        </div>
        <input id="inputAudio" type="file" accept="audio/*" class="hidden"/>
      </div>
      <footer class="px-4 sm:px-6 py-4 border-t border-gray-200">
        <button class="btn-secondary" data-close aria-label="Cerrar">Cerrar</button>
      </footer>
    </div>
  </div>

  <div id="modalLoc" class="modal" role="dialog" aria-modal="true" aria-labelledby="locTitle">
    <div class="modal-panel">
      <header class="px-4 sm:px-6 py-4 border-b border-gray-200 flex items-center justify-between">
        <h2 id="locTitle" class="text-lg font-semibold">Ubicaci√≥n</h2>
        <button class="btn-secondary" data-close aria-label="Cerrar">‚úï</button>
      </header>
      <div class="p-4 sm:px-6 sm:py-6 px-4 py-4 overflow-auto grow space-y-4">
        <label class="text-sm text-gray-700" for="locInput">Ingresa una ubicaci√≥n</label>
        <input id="locInput" type="text" placeholder="Ej. Coliseo, Roma" class="w-full rounded-xl border border-gray-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-accent/30 focus:border-accent/50">
        <div class="flex items-center gap-2">
          <button id="locSave" class="btn-secondary" disabled>Guardar</button>
          <button id="locClear" class="btn-secondary">Quitar</button>
        </div>
      </div>
      <footer class="px-4 sm:px-6 py-4 border-t border-gray-200">
        <button class="btn-secondary" data-close aria-label="Cerrar">Cerrar</button>
      </footer>
    </div>
  </div>

  <div id="modalPreview" class="modal" role="dialog" aria-modal="true" aria-labelledby="previewTitle">
    <div class="modal-panel">
      <header class="px-4 sm:px-6 py-4 border-b border-gray-200 flex items-center justify-between">
        <h2 id="previewTitle" class="text-lg font-semibold">Preview</h2>
        <button class="btn-secondary" data-close aria-label="Cerrar">‚úï</button>
      </header>
      <div class="p-4 sm:p-6 overflow-auto grow">
        <article class="max-w-2xl mx-auto bg-white rounded-2xl border border-gray-200 shadow-soft overflow-hidden">
          <div class="relative w-full aspect-video bg-gray-100">
            <img id="pvImg" alt="" class="absolute inset-0 w-full h-full object-cover hidden"/>
            <video id="pvVideo" class="absolute inset-0 w-full h-full hidden" playsinline controls></video>
          </div>
          <div class="p-4 sm:p-6 space-y-3">
            <h3 id="pvTitle" class="text-xl font-semibold text-gray-900"></h3>
            <p id="pvBody" class="text-gray-700 whitespace-pre-wrap"></p>
            <div id="pvMeta" class="flex flex-wrap items-center gap-2"></div>
            <div id="pvAudioWrap" class="hidden">
              <audio id="pvAudio" controls preload="none" class="w-full"></audio>
            </div>

            <!-- NUEVO (MVP): bloque TTS en preview si corresponde -->
            <div id="pvTTSBlock" class="hidden">
              <div class="mt-4 p-3 border border-amber-200 bg-amber-50 rounded-xl">
                <p class="text-sm text-amber-800">No hay video y a√∫n no hay narraci√≥n. Pod√©s generar TTS ahora.</p>
                <div class="mt-2 flex items-center gap-2">
                  <button id="pvBtnGenTTS" class="btn-primary">Generar narraci√≥n</button>
                  <button id="pvBtnSkipTTS" class="btn-secondary">Seguir sin narraci√≥n</button>
                </div>
              </div>
            </div>

          </div>
        </article>
      </div>
      <footer class="px-4 sm:px-6 py-4 border-t border-gray-200">
        <button class="btn-secondary" data-close aria-label="Cerrar">Cerrar</button>
      </footer>
    </div>
  </div>

  <!-- NUEVO (MVP): Modal IA simplificado -->
  <div id="modalAI" class="modal" role="dialog" aria-modal="true" aria-labelledby="aiTitle">
    <div class="modal-panel">
      <header class="px-4 sm:px-6 py-4 border-b border-gray-200 flex items-center justify-between">
        <h2 id="aiTitle" class="text-lg font-semibold">Asistente IA</h2>
        <button class="btn-secondary" data-close aria-label="Cerrar">‚úï</button>
      </header>
      <div class="p-4 sm:p-6 overflow-auto grow space-y-5">
        <section>
          <h3 class="text-sm font-semibold text-gray-600 mb-2">Texto</h3>
          <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
            <button class="tile p-4 text-left ai-action" data-action="pulir">
              <p class="font-semibold">Pulir texto</p>
              <p class="text-sm text-gray-600">Claridad y ortograf√≠a</p>
            </button>
            <button class="tile p-4 text-left ai-action" data-action="resumen">
              <p class="font-semibold">Resumen corto</p>
              <p class="text-sm text-gray-600">Ideal para la card</p>
            </button>
            <button class="tile p-4 text-left ai-action" data-action="titulos">
              <p class="font-semibold">Ideas de t√≠tulo</p>
              <p class="text-sm text-gray-600">3‚Äì5 alternativas</p>
            </button>
          </div>

          <!-- Resultados texto -->
          <div id="aiTextResults" class="mt-3 space-y-2"></div>
        </section>

        <section>
          <h3 class="text-sm font-semibold text-gray-600 mb-2">Im√°genes</h3>
          <div class="tile p-4">
            <p class="font-semibold">T√©rminos sugeridos</p>
            <p class="text-sm text-gray-600">Toc√° un chip para abrir b√∫squeda</p>
            <div id="aiSearchTerms" class="mt-3 flex flex-wrap gap-2"></div>
          </div>
        </section>
      </div>
      <footer class="px-4 sm:px-6 py-4 border-t border-gray-200">
        <button class="btn-secondary" data-close aria-label="Cerrar">Cerrar</button>
      </footer>
    </div>
  </div>

  <!-- NUEVO (MVP): Modal Publicar con TTS al final -->
  <div id="modalPublish" class="modal" role="dialog" aria-modal="true" aria-labelledby="pubTitle">
    <div class="modal-panel">
      <header class="px-4 sm:px-6 py-4 border-b border-gray-200 flex items-center justify-between">
        <h2 id="pubTitle" class="text-lg font-semibold">Listo para publicar</h2>
        <button class="btn-secondary" data-close aria-label="Cerrar">‚úï</button>
      </header>
      <div class="p-4 sm:p-6 overflow-auto grow space-y-4">
        <ul class="space-y-2 text-sm text-gray-800">
          <li>‚úÖ Texto completo</li>
          <li>‚úÖ Visual ok</li>
          <li id="pubTTSState">‚è≥ Narraci√≥n (TTS)</li>
        </ul>
        <div class="flex flex-wrap gap-2">
          <button id="pubBtnGenTTS" class="btn-primary">Generar narraci√≥n</button>
          <button id="pubBtnSkip" class="btn-secondary">Publicar sin narraci√≥n</button>
        </div>
      </div>
      <footer class="px-4 sm:px-6 py-4 border-t border-gray-200">
        <button class="btn-secondary" data-close aria-label="Cerrar">Cerrar</button>
      </footer>
    </div>
  </div>

<script>
(function(){
  /* ------------------- Datos de la colecci√≥n (mock) ------------------- */
  const collection = {
    id: "col-roma-classic",
    title: "Classic Rome",
    description: "Selecci√≥n curada de historias cortas para explorar Roma con contexto y emoci√≥n.",
    category: "turismo",
    price: 5.9,
    lang: "es",
    visibility: "public",
    cover: "https://images.unsplash.com/photo-1515548211226-5c1a24fa2f2c?q=80&w=1200&auto=format&fit=crop",
    updated: "2025-09-25",
    stories: [
      { id:"s1", title:"Coliseo ‚Äî Introducci√≥n", cover:"https://images.unsplash.com/photo-1515548211226-5c1a24fa2f2c?q=80&w=1200&auto=format&fit=crop", status:"published", updated:"2025-09-20", media:{type:"image", images:[
        "https://images.unsplash.com/photo-1566927463585-55a9a31f1d6b?q=80&w=1200&auto=format&fit=crop",
        "https://picsum.photos/seed/coliseo-2/1200/675"
      ]}, body:"El anfiteatro Flavio marc√≥ un antes y un despu√©s‚Ä¶" },
      { id:"s2", title:"Foro Romano ‚Äî Poder y ritual", cover:"https://images.unsplash.com/photo-1519681393784-d120267933ba?q=80&w=1200&auto=format&fit=crop", status:"draft", updated:"2025-09-22", media:{type:"image", images:["https://picsum.photos/seed/foro/1200/675"]}, body:"Entre templos y bas√≠licas civiles‚Ä¶" },
      { id:"s3", title:"Pante√≥n ‚Äî √ìculo y c√∫pula", cover:"https://images.unsplash.com/photo-1517637633369-e4cc8003b2fd?q=80&w=1200&auto=format&fit=crop", status:"published", updated:"2025-09-25", media:{type:"video", url:"https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.webm"}, body:"Una esfera perfecta que toca el suelo con luz‚Ä¶" }
    ]
  };

  /* --------------------- Helpers y refs --------------------- */
  const $ = (s,root=document)=> root.querySelector(s);
  const $$ = (s,root=document)=> Array.from(root.querySelectorAll(s));
  const nowTime = ()=> new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});

  const colTitle = $('#colTitle');
  const storiesList = $('#storiesList');
  const countLabel = $('#countLabel');
  const tileCreate = $('#tileCreate');

  // Right column
  const collectionPanel = $('#collectionPanel');
  const editorView    = $('#editorView');
  const editorToolbar = $('#editorToolbar');

  // Sidebar: colecci√≥n
  const acc       = $('#collectionAccordion');
  const mColSummaryTitle = $('#mColSummaryTitle');
  const mColMini  = $('#mColMini');
  const mColName  = $('#mColName');
  const mColDesc  = $('#mColDesc');
  const mColPrice = $('#mColPrice');
  const mColLang  = $('#mColLang');
  const mColSave  = $('#mColSaveBtn');

  const collectionCard = $('#collectionCard');
  const collectionCardTitle = $('#collectionCardTitle');
  const collectionCardMeta  = $('#collectionCardMeta');

  // Mobile sticky
  const mobileCreateSticky = $('#mobileCreateSticky');
  const stickyCreateBtn = $('#stickyCreateBtn');

  // Collection panel refs
  const colName  = $('#colName');
  const colDesc  = $('#colDesc');
  const colCat   = $('#colCat');
  const colPrice = $('#colPrice');
  const colLang  = $('#colLang');
  const colCoverPreview = $('#colCoverPreview');
  const colCoverBtn = $('#colCoverBtn');
  const colCoverInput = $('#colCoverInput');
  const colSaveBtn = $('#colSaveBtn');
  const colStats = $('#colStats');
  const saveHint = $('#saveHint');
  const saveTime = $('#saveTime');

  // Editor refs
  const currentStoryName = $('#currentStoryName');
  const emptyTiles = $('#emptyTiles');
  const emptyHint  = $('#emptyHint');
  const canvasSection = $('#canvasSection');
  const canvasDrop = $('#canvasDrop');
  const stageImg = $('#stageImg');
  const stageVideo = $('#stageVideo');
  const thumbs = $('#thumbs');
  const chipAddImg = $('#chipAddImg');
  const chipSearchImg = $('#chipSearchImg');
  const chipLoc = $('#chipLoc');
  const chipFile = $('#chipFile');
  const chipAudio = $('#chipAudio');
  const chipAI   = $('#chipAI'); // NUEVO (MVP)
  const modalAI  = $('#modalAI'); // NUEVO (MVP)

  const metaList = $('#metaList');
  const audioWrap = $('#audioWrap');
  const audioEl = $('#audioEl');
  const playLabel = $('#playLabel');
  const alertBox = $('#alert');
  const toast = $('#toast');

  const titleInput = $('#title');
  const bodyInput  = $('#body');
  const inputUploadImg = $('#inputUploadImg');
  const inputUploadVideo = $('#inputUploadVideo');

  // Audio modal refs
  const modalAudio = $('#modalAudio');
  const inputAudio = $('#inputAudio');
  const audioFileBtn = $('#audioFileBtn');
  const audioTTSBtn  = $('#audioTTSBtn');

  // Preview refs
  const modalPreview = $('#modalPreview');
  const pvImg = $('#pvImg');
  const pvVideo = $('#pvVideo');
  const pvTitle = $('#pvTitle');
  const pvBody  = $('#pvBody');
  const pvMeta  = $('#pvMeta');
  const pvAudioWrap = $('#pvAudioWrap');
  const pvAudio     = $('#pvAudio');
  const pvTTSBlock  = $('#pvTTSBlock'); // NUEVO (MVP)
  const pvBtnGenTTS = $('#pvBtnGenTTS'); // NUEVO (MVP)
  const pvBtnSkipTTS= $('#pvBtnSkipTTS'); // NUEVO (MVP)

  // Search modal refs
  const results = $('#results');
  const qInput  = $('#q');
  const btnDoSearch = $('#btnDoSearch');

  // Publicar modal (MVP)
  const modalPublish = $('#modalPublish');
  const pubTTSState  = $('#pubTTSState');
  const pubBtnGenTTS = $('#pubBtnGenTTS');
  const pubBtnSkip   = $('#pubBtnSkip');

  // Estado general
  const uiState = { selected: { type:'collection', id:'collection' } };

  // Estado del wizard story
  const state = {
    currentStoryId: null,
    mediaType:null, images:[], videoSrc:null,
    audioSrc:null, audioMode:null, loc:null, files:[],
    dirty:false,
    ttsHash:null // NUEVO (MVP) ‚Äî hash del texto para saber si la TTS est√° alineada
  };

  /* ---------------------- Render inicial ---------------------- */
  colTitle.textContent = collection.title;

  function renderSidebarCollection(){
    mColSummaryTitle.textContent = collection.title || 'Colecci√≥n';
    mColMini.textContent = `¬∑ ‚Ç¨${Number(collection.price||0).toFixed(2)} ¬∑ ${String(collection.lang||'es').toUpperCase()}`;
    collectionCardTitle.textContent = collection.title || 'Colecci√≥n';
    collectionCardMeta.textContent  = `√ölt. actualizaci√≥n ${collection.updated}`;
  }

  function renderStories(){
    countLabel.textContent = collection.stories.length;
    storiesList.innerHTML = '';
    collection.stories.forEach(st=>{
      const btn = document.createElement('button');
      btn.className = "sidebar-item w-full text-left rounded-2xl border border-gray-200 bg-white overflow-hidden shadow-[0_6px_18px_rgba(0,0,0,.06)] hover:shadow-[0_10px_26px_rgba(0,0,0,.08)] transition";
      btn.dataset.type='story'; btn.dataset.id=st.id;
      const imgSrc = st.cover || (st.media?.images?.[0]||`https://picsum.photos/seed/${st.id}/640/360`);
      btn.innerHTML = `
        <div class="card-media">
          <img src="${imgSrc}" alt="" class="block w-full h-28 object-cover"/>
          <div class="card-overlay"></div>
          <div class="meta-bar"><span class="opacity-90">${st.updated}</span></div>
          <span class="state-chip">${st.status==='published'?'Publicado':'Borrador'}</span>
        </div>
        <div class="p-3">
          <p class="font-semibold truncate">${escapeHtml(st.title)}</p>
          <p class="text-xs text-gray-500">ID: ${st.id}</p>
        </div>
      `;
      btn.addEventListener('click', ()=> guardedAction(()=> openEditorWithStory(st.id)));
      storiesList.appendChild(btn);
    });
    applySidebarSelection();
  }

  /* --------------------- Panel de colecci√≥n --------------------- */
  function fillCollectionPanel(){
    colName.value  = collection.title || '';
    colDesc.value  = collection.description || '';
    colCat.value   = collection.category || 'turismo';
    colPrice.value = (collection.price ?? '').toString();
    colLang.value  = collection.lang || 'es';
    (document.querySelector(`[name="colVisibility"][value="${collection.visibility||'public'}"]`)||{}).checked = true;
    colCoverPreview.src = collection.cover || '';

    mColName.value  = collection.title || '';
    mColDesc.value  = collection.description || '';
    mColPrice.value = (collection.price ?? '').toString();
    mColLang.value  = collection.lang || 'es';
    updateColStats();
  }
  function updateColStats(){
    const published = collection.stories.filter(s=>s.status==='published').length;
    colStats.textContent = `üóÇ ${collection.stories.length} stories ¬∑ ‚úÖ ${published} publicadas ¬∑ √ölt. actualizaci√≥n ${collection.updated}`;
  }
  colCoverBtn.addEventListener('click', ()=> colCoverInput.click());
  colCoverInput.addEventListener('change', (e)=>{
    const f=(e.target.files||[])[0]; if(!f) return;
    const url = URL.createObjectURL(f);
    collection.cover = url; colCoverPreview.src = url; markSaved();
  });
  function saveCollectionCommon(){
    const newTitle = (colName.value||mColName.value||'').trim();
    if(newTitle) collection.title = newTitle;
    collection.description = (colDesc.value||mColDesc.value||'').trim();
    collection.price = parseFloat((colPrice.value||mColPrice.value||'0'))||0;
    collection.lang = (colLang.value||mColLang.value||'es');
    collection.category = colCat.value || collection.category;
    const vis = document.querySelector('[name="colVisibility"]:checked');
    collection.visibility = vis ? vis.value : collection.visibility;
    collection.updated = new Date().toISOString().slice(0,10);
    colTitle.textContent = collection.title;
    renderSidebarCollection();
    fillCollectionPanel();
    showToast('Colecci√≥n guardada');
  }
  colSaveBtn.addEventListener('click', ()=> saveCollectionCommon());
  mColSave.addEventListener('click', ()=>{
    saveCollectionCommon();
    if(acc.open){ acc.open = false; }
  });

  /* --------------------- Sidebar interactions --------------------- */
  collectionCard.addEventListener('click', ()=>{
    uiState.selected = {type:'collection', id:'collection'};
    applySidebarSelection();
    showCollectionPanel();
  });
  function applySidebarSelection(){
    $$('.sidebar-item').forEach(el=> el.classList.remove('is-active'));
    if(uiState.selected.type==='collection'){
      collectionCard?.classList.add('is-active');
    }else if(uiState.selected.type==='story'){
      const match = $(`.sidebar-item[data-type="story"][data-id="${uiState.selected.id}"]`);
      match?.classList.add('is-active');
    }
  }

  function showCollectionPanel(){
    collectionPanel.classList.remove('hidden');
    editorView.classList.add('hidden');
    editorToolbar.classList.add('hidden');
    mobileCreateSticky.classList.remove('hidden');
  }
  function hideCollectionPanel(){ collectionPanel.classList.add('hidden'); }
  function collapseMobileAccordion(){ if(acc && acc.open) acc.open = false; }

  /* --------------------- Editor Story --------------------- */
  function openEditorWithStory(storyId){
    uiState.selected = {type:'story', id:storyId};
    applySidebarSelection();

    state.currentStoryId = storyId;
    const st = collection.stories.find(s=> s.id===storyId);
    if(!st) return;
    currentStoryName.textContent = st.title;
    titleInput.value = st.title || '';
    bodyInput.value  = st.body  || '';

    resetMediaState();
    if(st.media?.type === 'image'){
      state.images = (st.media.images||[]).map(src=> ({src, id:crypto.randomUUID()}));
      state.mediaType='image';
    }else if(st.media?.type === 'video'){
      state.videoSrc = st.media.url || null;
      state.mediaType = state.videoSrc ? 'video' : null;
    }
    renderWizard();
    hideCollectionPanel();
    collapseMobileAccordion();
    showEditor();
    restoreDraftIfMatches();
  }

  // Crear nueva
  tileCreate.addEventListener('click', ()=> guardedAction(startNewStory));
  stickyCreateBtn.addEventListener('click', ()=> guardedAction(startNewStory));
  function startNewStory(){
    uiState.selected = {type:'story', id:'new'};
    applySidebarSelection();

    state.currentStoryId = null;
    titleInput.value = '';
    bodyInput.value  = '';
    resetMediaState();
    renderWizard();
    currentStoryName.textContent = 'Nueva Story';
    hideCollectionPanel();
    collapseMobileAccordion();
    showEditor();
    restoreDraftIfMatches();
  }

  function showEditor(){
    hideCollectionPanel();
    editorView.classList.remove('hidden');
    editorToolbar.classList.remove('hidden');
    mobileCreateSticky.classList.add('hidden');
    if(window.matchMedia('(max-width: 1023px)').matches){
      editorView.classList.add('fullscreen'); window.scrollTo({top:0, behavior:'instant'});
    } else {
      editorView.classList.remove('fullscreen');
    }
  }
  function hideEditorMobile(){
    if(window.matchMedia('(max-width: 1023px)').matches){
      editorView.classList.remove('fullscreen');
      editorView.classList.add('hidden');
      editorToolbar.classList.add('hidden');
      mobileCreateSticky.classList.remove('hidden');
    }
  }
  $('#btnBackToList').addEventListener('click', ()=> guardedAction(hideEditorMobile));

  /* ---------------------------- Wizard behaviour ---------------------------- */
  function resetMediaState(){
    state.images=[]; state.videoSrc=null; state.mediaType=null;
    state.audioSrc=null; state.audioMode=null; state.loc=null; state.files=[];
    state.ttsHash=null;
    stopAudio(); setDirty(false);
  }

  function renderWizard(){
    const hasImages = state.images.length>0;
    const hasVideo  = !!state.videoSrc;

    emptyTiles.classList.toggle('hidden', hasImages || hasVideo);
    emptyHint.classList.toggle('hidden', hasImages || hasVideo);
    canvasSection.classList.toggle('hidden', !(hasImages || hasVideo));

    if(hasImages){
      stageImg.src = state.images[0].src; stageImg.classList.remove('hidden'); stageVideo.classList.add('hidden');
    }else if(hasVideo){
      stageVideo.src = state.videoSrc; stageVideo.classList.remove('hidden'); stageImg.classList.add('hidden');
    }else{
      stageImg.classList.add('hidden'); stageVideo.classList.add('hidden');
    }

    $('#carousel').classList.toggle('hidden', !hasImages);
    thumbs.innerHTML = '';
    if(hasImages){
      state.images.forEach((img,i)=>{
        const wrap=document.createElement('div'); wrap.className='relative snap-start';
        const el=document.createElement('img'); el.src=img.src; el.alt='Miniatura '+(i+1); el.className='thumb'; el.tabIndex=0;
        el.setAttribute('role','option'); el.setAttribute('aria-selected', i===0?'true':'false');
        el.addEventListener('click', ()=> makePrincipal(i));
        el.addEventListener('keydown', ev=>{ if(ev.key==='Enter'||ev.key===' '){ ev.preventDefault(); makePrincipal(i); }});
        const btn=document.createElement('button'); btn.className='absolute -top-2 -right-2 rounded-full bg-white border border-gray-200 w-7 h-7 shadow flex items-center justify-center'; btn.setAttribute('aria-label','Quitar imagen '+(i+1)); btn.textContent='‚úï';
        btn.addEventListener('click', ()=> removeImg(i));
        wrap.append(el,btn); thumbs.appendChild(wrap);
      });
    }

    chipAddImg.classList.toggle('hidden', !hasImages);
    chipSearchImg.classList.toggle('hidden', !hasImages);
    chipLoc.classList.toggle('hidden', !!state.loc);
    chipLoc.setAttribute('aria-pressed', state.loc ? 'true' : 'false');
    chipFile.classList.toggle('hidden', state.files.length>0);
    chipFile.setAttribute('aria-pressed', state.files.length>0 ? 'true' : 'false');

    // Audio visible si NO hay video
    const hasAudio = !!state.audioSrc;
    audioWrap.classList.toggle('hidden', hasVideo || !hasAudio);
    chipAudio.classList.toggle('hidden', hasVideo || hasAudio);
    chipAudio.setAttribute('aria-pressed', hasAudio ? 'true' : 'false');

    // Chips de meta
    metaList.innerHTML='';
    if(state.loc){
      const locChip = document.createElement('span');
      locChip.className = 'chip text-sm';
      locChip.innerHTML = `
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#111827" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M12 22s8-4.5 8-12a8 8 0 10-16 0c0 7.5 8 12 8 12z"/><circle cx="12" cy="10" r="3"/></svg>
        <span>üìç ${escapeHtml(state.loc)}</span>
        <button aria-label="Quitar ubicaci√≥n" class="ml-1">‚úï</button>`;
      locChip.querySelector('button').addEventListener('click', ()=>{ state.loc=null; setDirty(true); renderWizard(); });
      metaList.appendChild(locChip);
    }
    state.files.forEach(file=>{
      const c=document.createElement('span');
      c.className='chip chip-file text-sm';
      c.innerHTML=`
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#7f1d1d" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M14 2H6a2 2 0 00-2 2v16l4-2 4 2 4-2 4 2V8z"/></svg>
        <span>${escapeHtml(file.name)}</span>
        <button aria-label="Quitar adjunto" class="ml-1 text-red-700">‚úï</button>`;
      c.querySelector('button').addEventListener('click', ()=>{ state.files=[]; setDirty(true); renderWizard(); });
      metaList.appendChild(c);
    });

    // NUEVO (MVP): disponibilidad de IA
    updateAIAvailability();

    alertBox.classList.add('hidden');
  }

  function updateAIAvailability(){
    const titleLen = (titleInput.value||'').trim().length;
    const bodyLen  = (bodyInput.value||'').trim().length;
    const enabled = (titleLen>=10 || bodyLen>=30);
    chipAI.setAttribute('aria-disabled', enabled ? 'false' : 'true');
    chipAI.title = enabled ? 'Herramientas IA' : 'A√±ad√≠ t√≠tulo o cuerpo para usar IA';
  }

  function makePrincipal(i){ if(i===0) return; const [img]=state.images.splice(i,1); state.images.unshift(img); setDirty(true); renderWizard(); }
  function removeImg(i){ state.images.splice(i,1); if(state.images.length===0){ state.mediaType=null; } setDirty(true); renderWizard(); }

  // Inputs de subida
  $('#tileUploadImg').addEventListener('click', ()=> inputUploadImg.click());
  $('#tileVideo').addEventListener('click', ()=> inputUploadVideo.click());
  $('#tileSearch').addEventListener('click', ()=> openModal($('#modalSearch')));

  inputUploadImg.addEventListener('change', (e)=>{
    const files = Array.from(e.target.files||[]);
    if(!files.length) return;
    files.forEach(f=> state.images.unshift({src:URL.createObjectURL(f), id:crypto.randomUUID()}));
    state.mediaType='image'; state.videoSrc=null;
    stopAudio(); state.audioSrc=null; state.audioMode=null; state.ttsHash=null;
    setDirty(true); renderWizard(); e.target.value='';
  });
  inputUploadVideo.addEventListener('change', (e)=>{
    const f=(e.target.files||[])[0]; if(!f) return;
    state.videoSrc = URL.createObjectURL(f);
    state.mediaType='video'; state.images=[];
    stopAudio(); state.audioSrc=null; state.audioMode=null; state.ttsHash=null;
    setDirty(true); renderWizard(); e.target.value='';
  });

  // Drag & Drop al canvas
  ;['dragenter','dragover'].forEach(evt=>{
    canvasDrop.addEventListener(evt, ev=>{ ev.preventDefault(); canvasDrop.classList.add('ring-2','ring-accent/40'); });
  });
  ;['dragleave','drop'].forEach(evt=>{
    canvasDrop.addEventListener(evt, ev=>{ ev.preventDefault(); canvasDrop.classList.remove('ring-2','ring-accent/40'); });
  });
  canvasDrop.addEventListener('drop', ev=>{
    const f = ev.dataTransfer?.files?.[0]; if(!f) return;
    const url = URL.createObjectURL(f);
    if(f.type.startsWith('video/')){
      state.videoSrc = url; state.mediaType='video'; state.images=[]; state.audioSrc=null; state.audioMode=null; state.ttsHash=null;
    }else if(f.type.startsWith('image/')){
      state.images.unshift({src:url, id:crypto.randomUUID()}); state.mediaType='image'; state.videoSrc=null; state.ttsHash=null;
    }
    setDirty(true); renderWizard();
  });

  // Chips footer
  $('#chipLoc').addEventListener('click', ()=> openModal($('#modalLoc')));
  $('#chipFile').addEventListener('click', handleAddFile);
  $('#chipAudio').addEventListener('click', ()=> openModal($('#modalAudio')));
  $('#chipAddImg').addEventListener('click', ()=> inputUploadImg.click());
  $('#chipSearchImg').addEventListener('click', ()=> openModal($('#modalSearch')));

  // NUEVO (MVP): abrir modal IA solo si enabled
  chipAI.addEventListener('click', ()=>{
    if(chipAI.getAttribute('aria-disabled')==='true'){
      showToast('A√±ad√≠ t√≠tulo o cuerpo para usar IA');
      return;
    }
    renderAIModal(); openModal(modalAI);
  });

  // Texto cambia ‚Üí dirty + autosave + IA availability + invalidar TTS hash
  ;[titleInput, bodyInput].forEach(el=>{
    el.addEventListener('input', ()=>{
      setDirty(true); scheduleAutosave(); updateAIAvailability(); state.ttsHash=null;
    });
    el.addEventListener('change', ()=>{
      setDirty(true); scheduleAutosave(); updateAIAvailability(); state.ttsHash=null;
    });
  });

  // Preview / Save
  $('#btnPreview').addEventListener('click', ()=>{
    if (!validate(false)) { alertBox.classList.remove('hidden'); window.scrollTo({top:0, behavior:'smooth'}); return; }
    alertBox.classList.add('hidden');
    buildPreview();
    maybeShowPreviewTTSBlock();
    openModal(modalPreview);
  });

  $('#btnSave').addEventListener('click', ()=>{
    if(!validate(true)) return;
    // NUEVO (MVP): gating TTS al final si NO hay video y NO hay audio
    if(!state.videoSrc && !state.audioSrc){
      renderPublishModal();
      openModal(modalPublish);
      return;
    }
    // Si ya hay video o audio, persistimos
    persistStory(); setDirty(false); localStorage.removeItem('hg_draft_story'); showToast('Guardado');
  });

  // Validaci√≥n
  function validate(showAlert){
    const title=(titleInput.value||'').trim();
    const body =(bodyInput.value||'').trim();
    const hasText=!!(title||body);
    const hasVisual= state.images.length>0 || !!state.videoSrc;
    const needsAudio=!state.videoSrc; // solo si no hay video
    const hasAudio=!!state.audioSrc;
    const ok= hasText && hasVisual && (!needsAudio || hasAudio);
    if(!ok && showAlert){
      alertBox.classList.remove('hidden'); window.scrollTo({top:0, behavior:'smooth'});
    }
    return ok;
  }

  // Preview
  function buildPreview(){
    pvImg.classList.add('hidden'); pvVideo.classList.add('hidden');
    if(state.images.length){ pvImg.src = state.images[0].src; pvImg.classList.remove('hidden'); pvVideo.removeAttribute('src'); }
    else if(state.videoSrc){ pvVideo.src = state.videoSrc; pvVideo.classList.remove('hidden'); pvImg.removeAttribute('src'); }
    else { pvImg.removeAttribute('src'); pvVideo.removeAttribute('src'); }

    pvTitle.textContent = (titleInput.value||'').trim() || 'Sin t√≠tulo';
    pvBody.textContent  = (bodyInput.value||'').trim()  || '';

    pvMeta.innerHTML = '';
    if(state.loc){ const tag = document.createElement('span'); tag.className = 'tag'; tag.textContent = `üìç ${state.loc}`; pvMeta.appendChild(tag); }
    if(state.files.length){
      const f = state.files[0];
      const tag = document.createElement('span'); tag.className = 'tag';
      tag.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#475569" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M14 2H6a2 2 0 00-2 2v16l4-2 4 2 4-2 4 2V8z"/></svg> ${escapeHtml(f.name)}`;
      pvMeta.appendChild(tag);
    }

    if(state.audioSrc && !state.videoSrc){ pvAudio.src = state.audioSrc; pvAudioWrap.classList.remove('hidden'); }
    else { pvAudio.removeAttribute('src'); pvAudioWrap.classList.add('hidden'); }
  }

  // NUEVO (MVP): TTS block in preview
  function maybeShowPreviewTTSBlock(){
    const shouldOffer = (!state.videoSrc && !state.audioSrc);
    pvTTSBlock.classList.toggle('hidden', !shouldOffer);
  }
  pvBtnGenTTS?.addEventListener('click', async ()=>{
    await generateAndAttachTTS();
    buildPreview(); maybeShowPreviewTTSBlock(); showToast('Narraci√≥n generada'); // sigue en preview
  });
  pvBtnSkipTTS?.addEventListener('click', ()=>{
    pvTTSBlock.classList.add('hidden');
    showToast('Seguir sin narraci√≥n');
  });

  // --------- AUDIO: mini player controls ----------
  $('#btnPlay')?.addEventListener('click', ()=>{
    if(!state.audioSrc) return;
    if(audioEl.paused){ audioEl.play(); playLabel.textContent='‚è∏Ô∏é'; $('#btnPlay').setAttribute('aria-pressed','true'); }
    else { audioEl.pause(); playLabel.textContent='‚ñ∂Ô∏é'; $('#btnPlay').setAttribute('aria-pressed','false'); }
  });
  audioEl.addEventListener('ended', ()=> { playLabel.textContent='‚ñ∂Ô∏é'; $('#btnPlay').setAttribute('aria-pressed','false'); });
  $('#btnAudioRemove')?.addEventListener('click', ()=>{
    stopAudio(); state.audioSrc=null; state.audioMode=null; state.ttsHash=null; setDirty(true); renderWizard();
  });
  function stopAudio(){ try{ audioEl.pause(); }catch{} playLabel.textContent='‚ñ∂Ô∏é'; $('#btnPlay')?.setAttribute('aria-pressed','false'); }

  // --------- Adjuntos ----------
  function handleAddFile(){
    if(state.files.length>0) return;
    const io=document.createElement('input'); io.type='file'; io.className='hidden';
    io.addEventListener('change', ()=>{
      const f=(io.files||[])[0]; if(!f) return;
      state.files = [{name:f.name, id:crypto.randomUUID()}];
      setDirty(true); renderWizard();
    });
    document.body.appendChild(io); io.click(); setTimeout(()=> io.remove(), 0);
  }

  // --------- MODALES (focus trap + body scroll lock) ----------
  function focusablesIn(root){
    return Array.from(root.querySelectorAll('a,button,input,select,textarea,[tabindex]:not([tabindex="-1"])'))
      .filter(el=> !el.hasAttribute('disabled') && el.tabIndex !== -1);
  }
  let lastFocus = null;
  function openModal(m){
    if(!m) return;
    lastFocus = document.activeElement;
    document.body.style.overflow = 'hidden';
    m.classList.add('open');
    const panel = m.querySelector('.modal-panel');
    const fEls = focusablesIn(panel);
    const first = fEls[0] || panel; first.focus();
    m.__esc = (e)=>{ if(e.key==='Escape'){ closeModal(m); } };
    m.__trap = (e)=>{
      if(e.key!=='Tab') return;
      const els = focusablesIn(panel); if(!els.length) return;
      const idx = els.indexOf(document.activeElement);
      if(e.shiftKey && (idx<=0)){ e.preventDefault(); els[els.length-1].focus(); }
      else if(!e.shiftKey && (idx===els.length-1)){ e.preventDefault(); els[0].focus(); }
    };
    window.addEventListener('keydown', m.__esc);
    window.addEventListener('keydown', m.__trap);
    m.addEventListener('click', (e)=>{ if(e.target===m) closeModal(m); });
  }
  function closeModal(m){
    m.classList.remove('open');
    if(m.__esc){ window.removeEventListener('keydown', m.__esc); m.__esc=null; }
    if(m.__trap){ window.removeEventListener('keydown', m.__trap); m.__trap=null; }
    document.body.style.overflow = '';
    lastFocus?.focus();
  }
  $$('[data-close]').forEach(b=> b.addEventListener('click', ()=>{
    const m = b.closest('.modal'); if(m) closeModal(m);
  }));

  // --------- BUSCAR IM√ÅGENES (mock + skeletons) ----------
  function renderSkeletons(){
    results.innerHTML='';
    for(let i=0;i<9;i++){
      const sk=document.createElement('div');
      sk.className='rounded-xl border border-gray-200 bg-white overflow-hidden';
      sk.innerHTML=`<div class="bg-gray-100 animate-pulse w-full h-28"></div>
        <div class="p-2 flex items-center justify-between"><span class="bg-gray-100 h-3 w-24 rounded"></span><span class="bg-gray-100 h-8 w-16 rounded"></span></div>`;
      results.appendChild(sk);
    }
  }
  btnDoSearch.addEventListener('click', doSearch);
  qInput.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); doSearch(); }});
  function doSearch(){
    const q=(qInput.value||'italy').trim();
    renderSkeletons();
    setTimeout(()=>{
      results.innerHTML='';
      for(let i=0;i<9;i++){
        const url=`https://picsum.photos/seed/${encodeURIComponent(q)}-${i}/640/360`;
        const card=document.createElement('div'); card.className='overflow-hidden rounded-xl border border-gray-200 bg-white';
        card.innerHTML=`
          <img src="${url}" alt="${escapeHtml(q)}" class="w-full h-28 object-cover"/>
          <div class="p-2 flex items-center justify-between">
            <span class="text-sm text-gray-700 truncate">${escapeHtml(q)} #${i+1}</span>
            <button class="btn-secondary text-sm">Usar</button>
          </div>`;
        card.querySelector('button').addEventListener('click', ()=>{
          state.images.unshift({src:url, id:crypto.randomUUID()});
          state.mediaType='image'; state.videoSrc=null; setDirty(true); renderWizard(); closeModal($('#modalSearch'));
        });
        results.appendChild(card);
      }
    }, 350);
  }

  // --------- UBICACI√ìN ----------
  const locInput = $('#locInput'), locSave = $('#locSave');
  locInput.addEventListener('input', ()=>{
    const v = (locInput.value||'').trim();
    locSave.disabled = !v || v === state.loc;
  });
  $('#locSave').addEventListener('click', ()=>{
    const v=(locInput.value||'').trim();
    state.loc = v || null; setDirty(true); renderWizard(); closeModal($('#modalLoc'));
  });
  $('#locClear').addEventListener('click', ()=>{ state.loc=null; setDirty(true); renderWizard(); });

  // --------- AUDIO (archivo + TTS MOCK) ----------
  audioFileBtn.addEventListener('click', ()=> inputAudio.click());
  inputAudio.addEventListener('change', (e)=>{
    const f=(e.target.files||[])[0]; if(!f) return;
    state.audioSrc = URL.createObjectURL(f);
    state.audioMode = 'file'; state.ttsHash=null;
    setDirty(true); renderWizard(); closeModal(modalAudio); e.target.value='';
  });

  audioTTSBtn.addEventListener('click', async ()=>{
    await generateAndAttachTTS();
    closeModal(modalAudio);
  });

  async function generateAndAttachTTS(){
    try{
      const label = (titleInput.value || bodyInput.value || 'heyGuide audio').slice(0,80);
      const url = await generateAudioMockWithFallback(label);
      state.audioSrc = url;
      state.audioMode = 'tts';
      state.ttsHash = textHash(getPublishableText());
      setDirty(true);
      renderWizard();
      showToast('Narraci√≥n TTS lista');
    }catch(err){
      console.error(err);
      alert('Tu navegador no soporta el mock de TTS. Prob√° con ‚ÄúArchivo‚Äù.');
    }
  }

  async function generateAudioMockWithFallback(label='heyGuide'){
    const canMediaRecorder = ('MediaRecorder' in window);
    const canWebm = canMediaRecorder && MediaRecorder.isTypeSupported?.('audio/webm;codecs=opus');
    if(canWebm) return generateTTSAudioMockWebM();
    return generateTTSAudioMockWav();
  }
  async function generateTTSAudioMockWebM(){
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const dest = ctx.createMediaStreamDestination();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();

    osc.type = 'sine';
    const now = ctx.currentTime;
    osc.frequency.setValueAtTime(440, now);
    osc.frequency.linearRampToValueAtTime(660, now + 0.8);

    gain.gain.setValueAtTime(0.0001, now);
    gain.gain.exponentialRampToValueAtTime(0.4, now + 0.05);
    gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.8);

    osc.connect(gain);
    gain.connect(dest);
    gain.connect(ctx.destination);

    const stream = dest.stream;
    const rec = new MediaRecorder(stream, { mimeType: 'audio/webm;codecs=opus' });
    const chunks = [];
    rec.ondataavailable = e=>{ if(e.data.size>0) chunks.push(e.data); };

    const started = new Promise(res=> rec.onstart = res);
    const stopped = new Promise(res=> rec.onstop  = res);

    rec.start();
    await started;
    osc.start(now);
    await new Promise(r=> setTimeout(r, 820));
    osc.stop();
    rec.stop();
    await stopped;
    ctx.close();

    const blob = new Blob(chunks, { type: 'audio/webm;codecs=opus' });
    return URL.createObjectURL(blob);
  }
  async function generateTTSAudioMockWav(){
    const sampleRate = 44100, duration = 0.82;
    const offline = new (window.OfflineAudioContext || window.webkitOfflineAudioContext)(1, sampleRate*duration, sampleRate);
    const osc = offline.createOscillator(); const gain = offline.createGain();
    osc.type = 'sine'; osc.frequency.setValueAtTime(440, 0); osc.frequency.linearRampToValueAtTime(660, duration);
    gain.gain.setValueAtTime(0.0001, 0); gain.gain.exponentialRampToValueAtTime(0.4, 0.05); gain.gain.exponentialRampToValueAtTime(0.0001, duration);
    osc.connect(gain); gain.connect(offline.destination); osc.start(0); osc.stop(duration);
    const rendered = await offline.startRendering(); const wav = encodeWAV(rendered); const blob = new Blob([wav], { type: 'audio/wav' });
    return URL.createObjectURL(blob);
  }
  function encodeWAV(audioBuffer){
    const numChannels = audioBuffer.numberOfChannels, sampleRate = audioBuffer.sampleRate, samples = audioBuffer.getChannelData(0);
    const buffer = new ArrayBuffer(44 + samples.length*2); const view = new DataView(buffer);
    writeString(view, 0, 'RIFF'); view.setUint32(4, 36 + samples.length*2, true); writeString(view, 8, 'WAVE');
    writeString(view, 12, 'fmt '); view.setUint32(16, 16, true); view.setUint16(20, 1, true);
    view.setUint16(22, numChannels, true); view.setUint32(24, sampleRate, true);
    view.setUint32(28, sampleRate * numChannels * 2, true); view.setUint16(32, numChannels * 2, true); view.setUint16(34, 16, true);
    writeString(view, 36, 'data'); view.setUint32(40, samples.length*2, true);
    floatTo16BitPCM(view, 44, samples); return view;
  }
  function floatTo16BitPCM(view, offset, input){
    for (let i = 0; i < input.length; i++, offset += 2){
      let s = Math.max(-1, Math.min(1, input[i]));
      view.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
    }
  }
  function writeString(view, offset, string){ for (let i = 0; i < string.length; i++){ view.setUint8(offset + i, string.charCodeAt(i)); } }

  /* ------------------ AUTOSAVE (localStorage) ------------------ */
  let autosaveTimer;
  function scheduleAutosave(){
    clearTimeout(autosaveTimer);
    autosaveTimer = setTimeout(()=>{
      const draft = {
        id: state.currentStoryId || 'new',
        title: titleInput.value, body: bodyInput.value,
        mediaType: state.mediaType, images: state.images, videoSrc: state.videoSrc,
        audioSrc: state.audioSrc, loc: state.loc, files: state.files, ttsHash: state.ttsHash
      };
      localStorage.setItem('hg_draft_story', JSON.stringify(draft));
      markSaved();
    }, 1200);
  }
  function restoreDraftIfMatches(){
    try{
      const d = JSON.parse(localStorage.getItem('hg_draft_story')||'null');
      if(!d) return;
      const match = (!state.currentStoryId && d.id==='new') || (state.currentStoryId && d.id===state.currentStoryId);
      if(match){
        titleInput.value = d.title||''; bodyInput.value = d.body||'';
        state.mediaType = d.mediaType||null;
        state.images = Array.isArray(d.images)? d.images : [];
        state.videoSrc = d.videoSrc||null;
        state.audioSrc = d.audioSrc||null;
        state.loc = d.loc||null;
        state.files = Array.isArray(d.files)? d.files : [];
        state.ttsHash = d.ttsHash || null;
        renderWizard();
      }
    }catch{}
  }
  function markSaved(){ saveTime.textContent = nowTime(); saveHint.classList.remove('hidden'); }
  function setDirty(v){ state.dirty = !!v; }
  function guardedAction(fn){
    if(!state.dirty){ fn(); return; }
    const ok = confirm('Hay cambios sin guardar. ¬øSalir igualmente?');
    if(ok){ setDirty(false); fn(); }
  }
  window.addEventListener('beforeunload', (e)=>{
    if(!state.dirty) return; e.preventDefault(); e.returnValue = '';
  });

  // --------- Persistencia mock de la Story ----------
  function persistStory(){
    const isNew = !state.currentStoryId;
    const coverFallback = "https://picsum.photos/seed/"+(state.currentStoryId||'new')+"/1200/675";
    const media = state.videoSrc ? {type:'video', url:state.videoSrc} : {type:'image', images:state.images.map(i=>i.src)};

    if(isNew){
      const newId = "s" + (collection.stories.length+1);
      const cover = state.images[0]?.src || coverFallback;
      collection.stories.unshift({
        id:newId,
        title:titleInput.value || "Nueva Story",
        cover,
        status:"draft",
        updated:new Date().toISOString().slice(0,10),
        media,
        body: bodyInput.value||""
      });
      state.currentStoryId = newId;
      renderStories(); updateColStats();
    }else{
      const st = collection.stories.find(s=> s.id===state.currentStoryId);
      if(st){
        st.title = titleInput.value || st.title;
        st.updated = new Date().toISOString().slice(0,10);
        st.body = bodyInput.value;
        st.media = media;
        st.cover = st.media.type==='image' ? st.media.images[0] : st.cover;
        renderStories(); updateColStats();
      }
    }
  }

  // --------- Modal Publicar (MVP) ----------
  function renderPublishModal(){
    pubTTSState.textContent = '‚è≥ Narraci√≥n (TTS)';
  }
  pubBtnGenTTS.addEventListener('click', async ()=>{
    await generateAndAttachTTS();
    pubTTSState.textContent = '‚úÖ Narraci√≥n lista';
    // Simular publicar guardando
    persistStory(); setDirty(false); localStorage.removeItem('hg_draft_story'); showToast('Guardado con narraci√≥n');
    closeModal(modalPublish);
  });
  pubBtnSkip.addEventListener('click', ()=>{
    persistStory(); setDirty(false); localStorage.removeItem('hg_draft_story'); showToast('Guardado (sin narraci√≥n)');
    closeModal(modalPublish);
  });

  /* ------------------ IA (MVP): Render y Acciones ------------------ */
  function renderAIModal(){
    // limpiar resultados
    $('#aiTextResults').innerHTML = '';
    $('#aiSearchTerms').innerHTML = '';
    // render chips de t√©rminos a partir del t√≠tulo/cuerpo/loc
    const terms = buildSearchTerms();
    terms.forEach(t=>{
      const chip=document.createElement('button');
      chip.className='chip text-sm';
      chip.textContent = '# ' + t;
      chip.addEventListener('click', ()=>{
        qInput.value = t;
        closeModal(modalAI);
        openModal($('#modalSearch'));
        doSearch();
      });
      $('#aiSearchTerms').appendChild(chip);
    });
  }

  // Tiles de texto
  $$('.ai-action', modalAI).forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const action = btn.dataset.action;
      const title = (titleInput.value||'').trim();
      const body  = (bodyInput.value||'').trim();
      const results = $('#aiTextResults'); results.innerHTML='';
      if(!(title.length>=1 || body.length>=1)){
        results.innerHTML = `<div class="text-sm text-gray-600">Necesit√°s t√≠tulo o cuerpo para usar esta opci√≥n.</div>`;
        return;
      }
      if(action==='pulir'){
        const polishedTitle = title ? polishText(title) : '';
        const polishedBody  = body  ? polishText(body)  : '';
        const card = makeResultCard('Pulido', polishedTitle, polishedBody, ()=>{
          if(polishedTitle) titleInput.value = polishedTitle;
          if(polishedBody)  bodyInput.value  = polishedBody;
          setDirty(true); updateAIAvailability(); showToast('Aplicado (pulido)');
        });
        results.appendChild(card);
      }else if(action==='resumen'){
        const summary = summarizeText(body || title, 200);
        const card = makeResultCard('Resumen', '', summary, ()=>{
          bodyInput.value = summary; setDirty(true); updateAIAvailability(); showToast('Aplicado (resumen)');
        });
        results.appendChild(card);
      }else if(action==='titulos'){
        const ideas = generateTitles(title||body);
        const list = document.createElement('div');
        list.className='space-y-2';
        ideas.forEach(t=>{
          const row=document.createElement('div');
          row.className='flex items-center justify-between gap-2 rounded-xl border border-gray-200 p-2';
          row.innerHTML=`<span class="text-sm">${escapeHtml(t)}</span>`;
          const apply=document.createElement('button'); apply.className='btn-secondary text-sm'; apply.textContent='Usar';
          apply.addEventListener('click', ()=>{ titleInput.value = t; setDirty(true); updateAIAvailability(); showToast('T√≠tulo aplicado'); });
          row.appendChild(apply); list.appendChild(row);
        });
        const wrap=document.createElement('div');
        wrap.innerHTML=`<p class="font-semibold mb-2">Ideas de t√≠tulo</p>`;
        wrap.appendChild(list);
        results.appendChild(wrap);
      }
    });
  });

  function makeResultCard(label, title, body, onApply){
    const card=document.createElement('div');
    card.className='rounded-xl border border-gray-200 p-3';
    card.innerHTML = `<p class="text-sm text-gray-600 mb-2">${label}</p>
      ${title?`<p class="font-semibold mb-1">${escapeHtml(title)}</p>`:''}
      ${body?`<p class="text-sm text-gray-800 whitespace-pre-wrap">${escapeHtml(body)}</p>`:''}`;
    const actions=document.createElement('div'); actions.className='mt-2 flex gap-2';
    const apply=document.createElement('button'); apply.className='btn-primary'; apply.textContent='Aplicar';
    const discard=document.createElement('button'); discard.className='btn-secondary'; discard.textContent='Descartar';
    apply.addEventListener('click', ()=> onApply && onApply());
    discard.addEventListener('click', ()=> card.remove());
    actions.append(apply,discard); card.appendChild(actions);
    return card;
  }

  // Heur√≠sticas simples (mock IA)
  function polishText(s){ return s.replace(/\s+/g,' ').trim().replace(/(^\w|\.\s+\w)/g, m=>m.toUpperCase()); }
  function summarizeText(s, max=200){
    const txt = s.replace(/\s+/g,' ').trim();
    if(txt.length<=max) return txt;
    const cut = txt.slice(0,max);
    const lastDot = cut.lastIndexOf('.');
    return (lastDot>50? cut.slice(0,lastDot+1) : cut+'‚Ä¶');
  }
  function generateTitles(seed){
    const base = seed?.split(/[‚Äì‚Äî\-:|]/)[0]?.trim() || 'Tu historia';
    return [
      `${base}: esencia y contexto`,
      `${base} ‚Äî gu√≠a breve`,
      `Descubr√≠ ${base}`,
      `${base} en 3 minutos`,
      `${base}: lo imperdible`
    ];
  }
  function buildSearchTerms(){
    const title=(titleInput.value||'').toLowerCase();
    const body =(bodyInput.value||'').toLowerCase();
    const loc = (state.loc||'').toLowerCase();
    const key = (title+' '+body+' '+loc).replace(/[^\p{L}\p{N}\s]/gu,'').split(/\s+/).filter(w=>w.length>3);
    const uniq = Array.from(new Set(key)).slice(0,8);
    const extras = ['arquitectura','detalle','panor√°mica','noche','interior','textura'];
    const terms = [];
    if(loc) terms.push(loc);
    if(title) terms.push(title);
    uniq.forEach(w=> terms.push((loc?loc+' ':'')+w));
    extras.forEach(e=> terms.push((loc?loc+' ':'')+e));
    return Array.from(new Set(terms)).slice(0,10);
  }

  // --------- TTS helpers (MVP) ----------
  function getPublishableText(){
    const t=(titleInput.value||'').trim();
    const b=(bodyInput.value||'').trim();
    return `${t}\n\n${b}`.trim();
  }
  function textHash(s){
    let h=0, i=0, len=s.length;
    while(i<len){ h=((h<<5)-h) + s.charCodeAt(i++) | 0; }
    return h.toString();
  }

  // --------- Toast ----------
  let toastTimer;
  function showToast(msg='Guardado'){
    toast.textContent = msg;
    toast.classList.add('show');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(()=> toast.classList.remove('show'), 1400);
  }

  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

  // Init
  renderSidebarCollection();
  renderStories();
  fillCollectionPanel();

  // Estado inicial
  if(window.matchMedia('(min-width: 1024px)').matches){
    uiState.selected = {type:'collection', id:'collection'};
    applySidebarSelection();
    collectionPanel.classList.remove('hidden');
    editorView.classList.add('hidden');
    editorToolbar.classList.add('hidden');
  }else{
    acc.open = false;
    mobileCreateSticky.classList.remove('hidden');
  }

  // Responder a resize
  window.addEventListener('resize', ()=>{
    const isDesktop = window.matchMedia('(min-width: 1024px)').matches;
    if (isDesktop) {
      const editorActivo = !editorView.classList.contains('hidden');
      collectionPanel.classList.toggle('hidden', editorActivo);
    } else {
      collectionPanel.classList.add('hidden');
    }
  });
})();
</script>
</body>
</html>
